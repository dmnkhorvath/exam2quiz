server:
  http_listen_port: 9080

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ["__meta_docker_container_name"]
        regex: "/?(.*)"
        target_label: container
      - source_labels: ["__meta_docker_compose_service"]
        target_label: service
      - source_labels: ["__meta_docker_container_log_stream"]
        target_label: stream
      - source_labels: ["__meta_docker_compose_project"]
        target_label: project
    pipeline_stages:
      - docker: {}
      # Parse structured worker logs: [stage] [LEVEL] event: message {json_meta}
      - regex:
          expression: '^\[(?P<pipeline_stage>[a-z\-]+)\] \[(?P<log_level>[A-Z]+)\] (?P<event_name>[a-z_]+): (?P<log_message>.*?)(?:\s+(?P<json_meta>\{.*\}))?$'
      - labels:
          pipeline_stage:
          log_level:
          event_name:
      # Extract tenantId and pipelineRunId from JSON metadata when present
      - regex:
          source: json_meta
          expression: '"tenantId"\s*:\s*"(?P<tenant_id>[^"]+)"'
      - regex:
          source: json_meta
          expression: '"pipelineRunId"\s*:\s*"(?P<pipeline_run_id>[^"]+)"'
      - labels:
          tenant_id:
          pipeline_run_id:
